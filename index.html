<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Планировщик публикаций контента</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --text:#e9eef5;
      --muted:#9aa7b2;
      --primary:#6aa7ff;
      --accent:#c29bff;
      --success:#28c281;
      --warning:#ffb347;
      --danger:#ff6b6b;
      --border:#23262d;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --grad:linear-gradient(135deg,var(--primary),var(--accent));
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      min-height:100vh;
    }
    .container{
      max-width:700px;
      margin:0 auto;
      padding:40px 20px;
    }
    .header{
      text-align:center;
      margin-bottom:40px;
    }
    .header h1{
      font-weight:800;
      font-size:clamp(28px,6vw,36px);
      line-height:1.2;
      margin:0 0 8px;
    }
    .header p{
      color:var(--muted);
      margin:0;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:32px;
    }
    .form-group{
      margin-bottom:28px;
    }
    .form-label{
      display:block;
      font-weight:700;
      margin-bottom:10px;
      font-size:15px;
    }
    .form-input{
      width:100%;
      padding:14px 16px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-size:16px;
      font-family:inherit;
      transition:border-color .15s;
    }
    .form-input:focus{
      outline:none;
      border-color:var(--primary);
    }
    .form-input::placeholder{
      color:var(--muted);
    }
    .form-textarea{
      width:100%;
      padding:14px 16px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-size:16px;
      font-family:inherit;
      transition:border-color .15s;
      resize:vertical;
      min-height:80px;
    }
    .form-textarea:focus{
      outline:none;
      border-color:var(--primary);
    }
    .form-textarea::placeholder{
      color:var(--muted);
    }
    .content-type-buttons{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    .type-btn{
      padding:16px 12px;
      background:rgba(255,255,255,.03);
      border:2px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-weight:600;
      font-size:15px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:90px;
      touch-action:manipulation;
      user-select:none;
    }
    .type-btn:active{
      opacity:.7;
    }
    .type-btn.active{
      background:var(--grad);
      border-color:transparent;
      color:#0b1020;
    }
    .type-btn .icon{
      font-size:24px;
    }
    .type-btn .label{
      font-size:14px;
    }
    .platform-buttons{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    .platform-btn{
      padding:14px 16px;
      background:rgba(255,255,255,.03);
      border:2px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      min-height:50px;
      touch-action:manipulation;
      user-select:none;
    }
    .platform-btn:active{
      opacity:.7;
    }
    .platform-btn.active{
      background:var(--grad);
      border-color:transparent;
      color:#0b1020;
    }
    .platform-btn .icon{
      font-size:18px;
      min-width:20px;
    }
    .submit-btn{
      width:100%;
      padding:16px;
      background:var(--grad);
      border:none;
      border-radius:12px;
      color:#0b1020;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      margin-top:12px;
      touch-action:manipulation;
      user-select:none;
    }
    .submit-btn:active{
      opacity:.8;
    }
    .submit-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .bulk-import-btn{
      width:100%;
      padding:14px;
      background:rgba(255,255,255,.05);
      border:2px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      margin-top:12px;
      touch-action:manipulation;
      user-select:none;
    }
    .bulk-import-btn:active{
      opacity:.7;
    }
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.7);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal.show{
      display:flex;
    }
    .modal-content{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:32px;
      max-width:500px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .modal-header{
      font-size:22px;
      font-weight:800;
      margin:0 0 20px;
    }
    .modal-body{
      margin-bottom:24px;
    }
    .confirmation-item{
      padding:12px;
      background:rgba(255,255,255,.03);
      border-radius:8px;
      margin-bottom:8px;
    }
    .confirmation-label{
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
      margin-bottom:4px;
    }
    .confirmation-value{
      color:var(--text);
      font-weight:500;
      word-break:break-word;
    }
    .modal-actions{
      display:flex;
      gap:12px;
    }
    .modal-btn{
      flex:1;
      padding:14px;
      border:none;
      border-radius:10px;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .modal-btn.confirm{
      background:var(--grad);
      color:#0b1020;
    }
    .modal-btn.cancel{
      background:rgba(255,255,255,.05);
      color:var(--text);
      border:1px solid var(--border);
    }
    .modal-btn:active{
      opacity:.7;
    }
    .success-message{
      background:rgba(40,194,129,.1);
      border:1px solid rgba(40,194,129,.3);
      color:var(--success);
      padding:16px;
      border-radius:12px;
      margin-top:20px;
      text-align:center;
      font-weight:600;
      display:none;
    }
    .success-message.show{
      display:block;
    }
    .error-message{
      background:rgba(255,107,107,.1);
      border:1px solid rgba(255,107,107,.3);
      color:var(--danger);
      padding:16px;
      border-radius:12px;
      margin-top:20px;
      text-align:center;
      font-weight:600;
      display:none;
    }
    .error-message.show{
      display:block;
    }
    .checkbox-wrapper{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
    }
    .checkbox{
      width:18px;
      height:18px;
      cursor:pointer;
    }
    .checkbox-label{
      font-size:14px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    #deadlineGroup{
      display:none;
    }
    #deadlineGroup.show{
      display:block;
    }
    #commentGroup{
      display:none;
    }
    #commentGroup.show{
      display:block;
    }
    .bulk-modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.7);
      z-index:1001;
      align-items:center;
      justify-content:center;
      padding:20px;
      overflow-y:auto;
    }
    .bulk-modal.show{
      display:flex;
    }
    .bulk-modal-content{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:32px;
      max-width:600px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      max-height:90vh;
      overflow-y:auto;
    }
    .bulk-textarea{
      width:100%;
      min-height:200px;
      padding:14px 16px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text);
      font-size:14px;
      font-family:monospace;
      resize:vertical;
    }
    .bulk-textarea:focus{
      outline:none;
      border-color:var(--primary);
    }
    .bulk-textarea::placeholder{
      color:var(--muted);
    }
    .time-selector{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:10px;
    }
    .time-btn{
      padding:12px;
      background:rgba(255,255,255,.03);
      border:2px solid var(--border);
      border-radius:10px;
      color:var(--text);
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      touch-action:manipulation;
      user-select:none;
    }
    .time-btn:active{
      opacity:.7;
    }
    .time-btn.active{
      background:var(--grad);
      border-color:transparent;
      color:#0b1020;
    }
    .bulk-group-preview{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
    }
    .bulk-group-header{
      font-weight:700;
      font-size:15px;
      margin-bottom:8px;
      color:var(--primary);
    }
    .bulk-group-info{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .bulk-total{
      font-size:16px;
      font-weight:700;
      color:var(--success);
      text-align:center;
      padding:16px;
      background:rgba(40,194,129,.1);
      border-radius:12px;
      margin-top:16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📱 Планировщик контента</h1>
      <p>Управление публикациями в социальных сетях</p>
    </div>

    <div class="card">
      <form id="taskForm">
        <!-- Ссылка на материал -->
        <div class="form-group">
          <label class="form-label">🔗 Ссылка на материал</label>
          <input 
            type="url" 
            class="form-input" 
            id="materialLink" 
            placeholder="https://example.com/material"
            required
          />
        </div>

        <!-- Выбор типа контента -->
        <div class="form-group">
          <label class="form-label">📋 Тип контента</label>
          <div class="content-type-buttons">
            <button type="button" class="type-btn" data-type="Пост">
              <span class="icon">📝</span>
              <span class="label">Пост</span>
            </button>
            <button type="button" class="type-btn" data-type="Ролик">
              <span class="icon">🎬</span>
              <span class="label">Ролик</span>
            </button>
            <button type="button" class="type-btn" data-type="Карусель">
              <span class="icon">🎠</span>
              <span class="label">Карусель</span>
            </button>
          </div>
        </div>

        <!-- Выбор платформ (динамически меняется) -->
        <div class="form-group" id="platformsGroup" style="display:none;">
          <label class="form-label">🌐 Где опубликовать</label>
          <div class="platform-buttons" id="platformButtons">
            <!-- Динамически заполняется JS -->
          </div>
        </div>

        <!-- Чекбокс для дедлайна -->
        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="hasDeadline" class="checkbox" />
            <label for="hasDeadline" class="checkbox-label">Указать дедлайн</label>
          </div>
        </div>

        <!-- Дедлайн (показывается при включении чекбокса) -->
        <div class="form-group" id="deadlineGroup">
          <label class="form-label">📅 Дедлайн</label>
          <input 
            type="datetime-local" 
            class="form-input" 
            id="deadline"
          />
        </div>

        <!-- Чекбокс для комментария -->
        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="hasComment" class="checkbox" />
            <label for="hasComment" class="checkbox-label">Оставить комментарий</label>
          </div>
        </div>

        <!-- Комментарий (показывается при включении чекбокса) -->
        <div class="form-group" id="commentGroup">
          <label class="form-label">💬 Комментарий к задаче</label>
          <textarea 
            class="form-textarea" 
            id="taskComment"
            placeholder="Добавьте комментарий к публикации..."
            rows="3"
          ></textarea>
        </div>

        <button type="submit" class="submit-btn">
          ✨ Отправить задачи
        </button>
        
        <button type="button" class="bulk-import-btn" id="bulkImportBtn">
          ⚡ Массовый импорт
        </button>
      </form>

      <div class="success-message" id="successMessage">
        ✅ Задачи успешно отправлены в Google Таблицу!
      </div>

      <div class="error-message" id="errorMessage">
        ❌ Ошибка при отправке. Проверьте настройки подключения.
      </div>
    </div>
  </div>

  <!-- Модальное окно подтверждения -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h2 class="modal-header">Подтверждение задач</h2>
      <div class="modal-body" id="confirmationBody">
        <!-- Динамический контент -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelBtn">Отмена</button>
        <button class="modal-btn confirm" id="confirmBtn">Подтвердить</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно массового импорта -->
  <div class="bulk-modal" id="bulkModal">
    <div class="bulk-modal-content">
      <h2 class="modal-header">⚡ Массовый импорт</h2>
      
      <div class="form-group">
        <label class="form-label">📝 Список ссылок (каждая с новой строки)</label>
        <textarea 
          class="bulk-textarea" 
          id="bulkLinks"
          placeholder="https://example.com/1
https://example.com/2
https://example.com/3
..."
        ></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">📋 Тип контента</label>
        <div class="content-type-buttons">
          <button type="button" class="type-btn" data-type="Пост">
            <span class="icon">📝</span>
            <span class="label">Пост</span>
          </button>
          <button type="button" class="type-btn" data-type="Ролик">
            <span class="icon">🎬</span>
            <span class="label">Ролик</span>
          </button>
          <button type="button" class="type-btn" data-type="Карусель">
            <span class="icon">🎠</span>
            <span class="label">Карусель</span>
          </button>
        </div>
      </div>

      <div class="form-group" id="bulkPlatformsGroup" style="display:none;">
        <label class="form-label">🌐 Где опубликовать</label>
        <div class="platform-buttons" id="bulkPlatformButtons">
          <!-- Динамически заполняется JS -->
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">⏰ Время дедлайна</label>
        <div class="time-selector">
          <button type="button" class="time-btn" data-time="12:00">12:00</button>
          <button type="button" class="time-btn" data-time="15:00">15:00</button>
          <button type="button" class="time-btn" data-time="19:00">19:00</button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn cancel" id="bulkCancelBtn">Отмена</button>
        <button class="modal-btn confirm" id="bulkPreviewBtn">Предпросмотр</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно предпросмотра массового импорта -->
  <div class="bulk-modal" id="bulkPreviewModal">
    <div class="bulk-modal-content">
      <h2 class="modal-header">📦 Предпросмотр импорта</h2>
      <div id="bulkPreviewContent">
        <!-- Динамический контент -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="bulkPreviewCancelBtn">Назад</button>
        <button class="modal-btn confirm" id="bulkConfirmBtn">Импортировать</button>
      </div>
    </div>
  </div>

  <script>
    // URL Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxr749U3VyolTQVFoK57dsXoTcsc00PUal1s238lM905fGeV8KepWvI1QjlwxMreWdVjw/exec';
    
    // Конфигурация платформ для разных типов контента
    const PLATFORMS = {
      'Пост': [
        { id: 'vk-personal', name: 'ВК - личный акк', icon: '👤' },
        { id: 'vk-group', name: 'ВК - пост группа', icon: '👥' },
        { id: 'ok-feed', name: 'ОК - пост в ленту', icon: '🟠' },
        { id: 'threads', name: 'Threads', icon: '🧵' }
      ],
      'Ролик': [
        { id: 'tiktok', name: 'TikTok', icon: '🎵' },
        { id: 'youtube-shorts', name: 'YouTube Shorts', icon: '📺' },
        { id: 'vk-clips', name: 'VK клипы', icon: '🎬' },
        { id: 'ok-video', name: 'ОК видео', icon: '🎥' },
        { id: 'dzen-video', name: 'Дзен видео', icon: '📹' }
      ],
      'Карусель': [
        { id: 'tiktok', name: 'TikTok', icon: '🎵' },
        { id: 'vk-post', name: 'ВК пост', icon: '📸' },
        { id: 'ok-post', name: 'ОК пост', icon: '🖼️' }
      ]
    };

    // Переменные
    const form = document.getElementById('taskForm');
    const modal = document.getElementById('confirmModal');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const typeButtons = document.querySelectorAll('.type-btn');
    const platformsGroup = document.getElementById('platformsGroup');
    const platformButtons = document.getElementById('platformButtons');
    const hasDeadlineCheckbox = document.getElementById('hasDeadline');
    const deadlineGroup = document.getElementById('deadlineGroup');
    const hasCommentCheckbox = document.getElementById('hasComment');
    const commentGroup = document.getElementById('commentGroup');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    
    let selectedType = null;
    let selectedPlatforms = new Set();
    let formData = {};

    // Переменные для массового импорта
    let bulkSelectedType = null;
    let bulkSelectedPlatforms = new Set();
    let bulkSelectedTime = null;
    let bulkData = {};

    // Инициализация
    window.addEventListener('DOMContentLoaded', () => {
      // Установка минимальной даты (текущее время по Москве)
      const now = new Date();
      // Преобразуем локальное время в московское
      const moscowOffset = 3 * 60; // GMT+3 в минутах
      const localOffset = now.getTimezoneOffset(); // смещение локального времени от UTC
      const totalOffset = moscowOffset + localOffset;
      const moscowTime = new Date(now.getTime() + totalOffset * 60 * 1000);
      
      // Форматируем для datetime-local input
      const year = moscowTime.getFullYear();
      const month = String(moscowTime.getMonth() + 1).padStart(2, '0');
      const day = String(moscowTime.getDate()).padStart(2, '0');
      const hours = String(moscowTime.getHours()).padStart(2, '0');
      const minutes = String(moscowTime.getMinutes()).padStart(2, '0');
      
      document.getElementById('deadline').min = `${year}-${month}-${day}T${hours}:${minutes}`;
    });

    // Обработка чекбокса дедлайна
    hasDeadlineCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        deadlineGroup.classList.add('show');
      } else {
        deadlineGroup.classList.remove('show');
        document.getElementById('deadline').value = '';
      }
    });

    // Обработка чекбокса комментария
    hasCommentCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        commentGroup.classList.add('show');
      } else {
        commentGroup.classList.remove('show');
        document.getElementById('taskComment').value = '';
      }
    });

    // Обработка выбора типа контента
    typeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type;
        
        // Снимаем выделение со всех кнопок
        typeButtons.forEach(b => b.classList.remove('active'));
        
        // Выделяем выбранную
        btn.classList.add('active');
        selectedType = type;
        
        // Сбрасываем выбранные платформы
        selectedPlatforms.clear();
        
        // Показываем соответствующие платформы
        renderPlatforms(type);
        
        // Показываем группу платформ
        platformsGroup.style.display = 'block';
      });
    });

    // Рендер платформ на основе выбранного типа
    function renderPlatforms(type) {
      const platforms = PLATFORMS[type];
      platformButtons.innerHTML = '';
      
      platforms.forEach(platform => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'platform-btn';
        btn.dataset.platformId = platform.id;
        btn.dataset.platformName = platform.name;
        btn.innerHTML = `
          <span class="icon">${platform.icon}</span>
          <span>${platform.name}</span>
        `;
        
        btn.addEventListener('click', () => {
          if (selectedPlatforms.has(platform.name)) {
            selectedPlatforms.delete(platform.name);
            btn.classList.remove('active');
          } else {
            selectedPlatforms.add(platform.name);
            btn.classList.add('active');
          }
        });
        
        platformButtons.appendChild(btn);
      });
    }

    // Отправка формы
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // Скрыть предыдущие сообщения
      successMessage.classList.remove('show');
      errorMessage.classList.remove('show');

      // Валидация
      if (!selectedType) {
        alert('Пожалуйста, выберите тип контента');
        return;
      }

      if (selectedPlatforms.size === 0) {
        alert('Пожалуйста, выберите хотя бы одну платформу для публикации');
        return;
      }

      // Проверка дедлайна
      const hasDeadline = hasDeadlineCheckbox.checked;
      const deadline = hasDeadline ? document.getElementById('deadline').value : null;
      
      if (hasDeadline && !deadline) {
        alert('Пожалуйста, укажите дедлайн или снимите галочку');
        return;
      }

      // Проверка комментария
      const hasComment = hasCommentCheckbox.checked;
      const comment = hasComment ? document.getElementById('taskComment').value.trim() : '';
      
      if (hasComment && !comment) {
        alert('Пожалуйста, введите комментарий или снимите галочку');
        return;
      }

      // Сохранение данных формы
      formData = {
        materialLink: document.getElementById('materialLink').value,
        contentType: selectedType,
        platforms: Array.from(selectedPlatforms),
        deadline: deadline,
        hasDeadline: hasDeadline,
        comment: comment,
        hasComment: hasComment
      };

      // Формирование подтверждения
      const platformNames = formData.platforms.join(', ');
      let deadlineFormatted = 'Не установлен';
      
      if (formData.hasDeadline && formData.deadline) {
        // Преобразуем datetime-local в московское время для отображения
        const deadlineDate = new Date(formData.deadline);
        const moscowOffset = 3 * 60;
        const localOffset = deadlineDate.getTimezoneOffset();
        const totalOffset = moscowOffset + localOffset;
        const moscowDeadline = new Date(deadlineDate.getTime() + totalOffset * 60 * 1000);
        
        const day = String(moscowDeadline.getDate()).padStart(2, '0');
        const month = String(moscowDeadline.getMonth() + 1).padStart(2, '0');
        const year = moscowDeadline.getFullYear();
        const hours = String(moscowDeadline.getHours()).padStart(2, '0');
        const minutes = String(moscowDeadline.getMinutes()).padStart(2, '0');
        
        deadlineFormatted = `${hours}:${minutes} ${day}.${month}.${year}`;
      }
      
      let confirmationHTML = `
        <div class="confirmation-item">
          <div class="confirmation-label">Ссылка на материал</div>
          <div class="confirmation-value">${formData.materialLink}</div>
        </div>
        <div class="confirmation-item">
          <div class="confirmation-label">Тип контента</div>
          <div class="confirmation-value">${formData.contentType}</div>
        </div>
        <div class="confirmation-item">
          <div class="confirmation-label">Платформы (${formData.platforms.length} задач)</div>
          <div class="confirmation-value">${platformNames}</div>
        </div>
        <div class="confirmation-item">
          <div class="confirmation-label">Дедлайн</div>
          <div class="confirmation-value">${deadlineFormatted}</div>
        </div>
      `;

      if (formData.hasComment) {
        confirmationHTML += `
          <div class="confirmation-item">
            <div class="confirmation-label">Комментарий</div>
            <div class="confirmation-value">${formData.comment}</div>
          </div>
        `;
      }

      document.getElementById('confirmationBody').innerHTML = confirmationHTML;
      modal.classList.add('show');
    });

    // Отмена
    cancelBtn.addEventListener('click', () => {
      modal.classList.remove('show');
    });

    // Закрытие по клику вне модального окна
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // Подтверждение и отправка в Google Sheets
    confirmBtn.addEventListener('click', async () => {
      modal.classList.remove('show');
      
      try {
        // Формирование задач
        const tasks = formData.platforms.map(platformName => ({
          materialLink: formData.materialLink,
          contentType: formData.contentType,
          platform: platformName,
          deadline: formData.hasDeadline ? formData.deadline : null,
          comment: formData.hasComment ? formData.comment : ''
        }));

        // Отправка в Google Sheets
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ tasks: tasks })
        });

        // Показать успешное сообщение
        successMessage.textContent = `✅ ${tasks.length} задач${tasks.length > 1 ? 'и' : 'а'} успешно отправлен${tasks.length > 1 ? 'ы' : 'а'} в Google Таблицу!`;
        successMessage.classList.add('show');
        
        // Сброс формы
        form.reset();
        selectedType = null;
        selectedPlatforms.clear();
        typeButtons.forEach(btn => btn.classList.remove('active'));
        platformsGroup.style.display = 'none';
        deadlineGroup.classList.remove('show');
        hasDeadlineCheckbox.checked = false;
        commentGroup.classList.remove('show');
        hasCommentCheckbox.checked = false;

        // Скрыть сообщение через 5 секунд
        setTimeout(() => {
          successMessage.classList.remove('show');
        }, 5000);

      } catch (error) {
        console.error('Ошибка:', error);
        errorMessage.classList.add('show');
        
        setTimeout(() => {
          errorMessage.classList.remove('show');
        }, 5000);
      }
    });

    // ============================================
    // МАССОВЫЙ ИМПОРТ
    // ============================================

    const bulkImportBtn = document.getElementById('bulkImportBtn');
    const bulkModal = document.getElementById('bulkModal');
    const bulkPreviewModal = document.getElementById('bulkPreviewModal');
    const bulkCancelBtn = document.getElementById('bulkCancelBtn');
    const bulkPreviewBtn = document.getElementById('bulkPreviewBtn');
    const bulkPreviewCancelBtn = document.getElementById('bulkPreviewCancelBtn');
    const bulkConfirmBtn = document.getElementById('bulkConfirmBtn');
    const bulkPlatformsGroup = document.getElementById('bulkPlatformsGroup');
    const bulkPlatformButtons = document.getElementById('bulkPlatformButtons');

    // Открытие модального окна массового импорта
    bulkImportBtn.addEventListener('click', () => {
      bulkModal.classList.add('show');
    });

    // Закрытие модального окна массового импорта
    bulkCancelBtn.addEventListener('click', () => {
      bulkModal.classList.remove('show');
    });

    bulkModal.addEventListener('click', (e) => {
      if (e.target === bulkModal) {
        bulkModal.classList.remove('show');
      }
    });

    // Обработка выбора типа контента для массового импорта
    const bulkTypeButtons = bulkModal.querySelectorAll('.type-btn');
    bulkTypeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type;
        
        bulkTypeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bulkSelectedType = type;
        
        bulkSelectedPlatforms.clear();
        renderBulkPlatforms(type);
        bulkPlatformsGroup.style.display = 'block';
      });
    });

    // Рендер платформ для массового импорта
    function renderBulkPlatforms(type) {
      const platforms = PLATFORMS[type];
      bulkPlatformButtons.innerHTML = '';
      
      platforms.forEach(platform => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'platform-btn';
        btn.dataset.platformName = platform.name;
        btn.innerHTML = `
          <span class="icon">${platform.icon}</span>
          <span>${platform.name}</span>
        `;
        
        btn.addEventListener('click', () => {
          if (bulkSelectedPlatforms.has(platform.name)) {
            bulkSelectedPlatforms.delete(platform.name);
            btn.classList.remove('active');
          } else {
            bulkSelectedPlatforms.add(platform.name);
            btn.classList.add('active');
          }
        });
        
        bulkPlatformButtons.appendChild(btn);
      });
    }

    // Обработка выбора времени
    const timeButtons = bulkModal.querySelectorAll('.time-btn');
    timeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        timeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bulkSelectedTime = btn.dataset.time;
      });
    });

    // Предпросмотр массового импорта
    bulkPreviewBtn.addEventListener('click', () => {
      // Валидация
      const linksText = document.getElementById('bulkLinks').value.trim();
      
      if (!linksText) {
        alert('Пожалуйста, введите список ссылок');
        return;
      }

      if (!bulkSelectedType) {
        alert('Пожалуйста, выберите тип контента');
        return;
      }

      if (bulkSelectedPlatforms.size === 0) {
        alert('Пожалуйста, выберите хотя бы одну платформу');
        return;
      }

      if (!bulkSelectedTime) {
        alert('Пожалуйста, выберите время дедлайна');
        return;
      }

      // Парсим ссылки (игнорируем пустые строки)
      const links = linksText.split('\n')
        .map(link => link.trim())
        .filter(link => link.length > 0);

      if (links.length === 0) {
        alert('Не найдено валидных ссылок');
        return;
      }

      // Группируем ссылки по 3
      const groups = [];
      for (let i = 0; i < links.length; i += 3) {
        groups.push(links.slice(i, i + 3));
      }

      // Формируем предпросмотр
      const platforms = Array.from(bulkSelectedPlatforms);
      const platformsText = platforms.join(', ');
      
      let previewHTML = '';
      let totalTasks = 0;

      groups.forEach((group, index) => {
        const hoursOffset = (index + 1) * 24;
        const deadline = calculateDeadline(hoursOffset, bulkSelectedTime);
        const tasksCount = group.length * platforms.length;
        totalTasks += tasksCount;

        const linkRange = group.length === 1 
          ? `ссылка ${index * 3 + 1}`
          : `ссылки ${index * 3 + 1}-${index * 3 + group.length}`;

        previewHTML += `
          <div class="bulk-group-preview">
            <div class="bulk-group-header">📦 Группа ${index + 1} (${linkRange})</div>
            <div class="bulk-group-info">→ ${platformsText}</div>
            <div class="bulk-group-info">→ Дедлайн: ${deadline}</div>
            <div class="bulk-group-info">→ Задач: ${tasksCount}</div>
          </div>
        `;
      });

      previewHTML += `
        <div class="bulk-total">
          Всего будет создано: ${totalTasks} задач
        </div>
      `;

      document.getElementById('bulkPreviewContent').innerHTML = previewHTML;

      // Сохраняем данные для импорта
      bulkData = {
        links: links,
        groups: groups,
        contentType: bulkSelectedType,
        platforms: platforms,
        time: bulkSelectedTime
      };

      // Показываем предпросмотр
      bulkModal.classList.remove('show');
      bulkPreviewModal.classList.add('show');
    });

    // Функция расчета дедлайна
    function calculateDeadline(hoursOffset, time) {
      const now = new Date();
      const moscowOffset = 3 * 60;
      const localOffset = now.getTimezoneOffset();
      const totalOffset = moscowOffset + localOffset;
      const moscowNow = new Date(now.getTime() + totalOffset * 60 * 1000);

      // Добавляем смещение в часах
      const deadline = new Date(moscowNow.getTime() + hoursOffset * 60 * 60 * 1000);

      // Устанавливаем выбранное время
      const [hours, minutes] = time.split(':');
      deadline.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      const day = String(deadline.getDate()).padStart(2, '0');
      const month = String(deadline.getMonth() + 1).padStart(2, '0');
      const year = deadline.getFullYear();

      return `${time} ${day}.${month}.${year}`;
    }

    // Функция создания ISO строки для дедлайна
    function createDeadlineISO(hoursOffset, time) {
      const now = new Date();
      const moscowOffset = 3 * 60;
      const localOffset = now.getTimezoneOffset();
      const totalOffset = moscowOffset + localOffset;
      const moscowNow = new Date(now.getTime() + totalOffset * 60 * 1000);

      const deadline = new Date(moscowNow.getTime() + hoursOffset * 60 * 60 * 1000);

      const [hours, minutes] = time.split(':');
      deadline.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      // Возвращаем в формате datetime-local
      const year = deadline.getFullYear();
      const month = String(deadline.getMonth() + 1).padStart(2, '0');
      const day = String(deadline.getDate()).padStart(2, '0');
      const h = String(deadline.getHours()).padStart(2, '0');
      const m = String(deadline.getMinutes()).padStart(2, '0');

      return `${year}-${month}-${day}T${h}:${m}`;
    }

    // Возврат к форме импорта
    bulkPreviewCancelBtn.addEventListener('click', () => {
      bulkPreviewModal.classList.remove('show');
      bulkModal.classList.add('show');
    });

    bulkPreviewModal.addEventListener('click', (e) => {
      if (e.target === bulkPreviewModal) {
        bulkPreviewModal.classList.remove('show');
      }
    });

    // Подтверждение и отправка массового импорта
    bulkConfirmBtn.addEventListener('click', async () => {
      bulkPreviewModal.classList.remove('show');

      try {
        // Формируем все задачи
        const allTasks = [];

        bulkData.groups.forEach((group, index) => {
          const hoursOffset = (index + 1) * 24;
          const deadlineISO = createDeadlineISO(hoursOffset, bulkData.time);

          group.forEach(link => {
            bulkData.platforms.forEach(platform => {
              allTasks.push({
                materialLink: link,
                contentType: bulkData.contentType,
                platform: platform,
                deadline: deadlineISO
              });
            });
          });
        });

        // Отправка в Google Sheets
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ tasks: allTasks })
        });

        // Показать успешное сообщение
        successMessage.textContent = `✅ Массовый импорт завершен! ${allTasks.length} задач отправлено в Google Таблицу!`;
        successMessage.classList.add('show');

        // Сброс формы массового импорта
        document.getElementById('bulkLinks').value = '';
        bulkSelectedType = null;
        bulkSelectedPlatforms.clear();
        bulkSelectedTime = null;
        bulkTypeButtons.forEach(btn => btn.classList.remove('active'));
        timeButtons.forEach(btn => btn.classList.remove('active'));
        bulkPlatformsGroup.style.display = 'none';

        setTimeout(() => {
          successMessage.classList.remove('show');
        }, 5000);

      } catch (error) {
        console.error('Ошибка:', error);
        errorMessage.classList.add('show');

        setTimeout(() => {
          errorMessage.classList.remove('show');
        }, 5000);
      }
    });
  </script>
</body>
</html>
